// KCISA 공연·전시·행사 → raw_sources(dataset: 'performance')
import { qs } from './lib/util.mjs';
import { upsertRaw } from './lib/db.mjs';

// serviceKey는 인코딩 키(Encoding) 그대로
function buildUrl(base, key, params){
  const rest = qs(params);
  return `${base}?serviceKey=${key}${rest ? `&${rest}` : ''}`;
}

// YYYYMMDD UTC
function ymdUTC(d=new Date()){
  const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,'0'), day=String(d.getUTCDate()).padStart(2,'0');
  return `${y}${m}${day}`;
}
function plusDaysYmd(n, base=new Date()){ const d=new Date(base); d.setUTCDate(d.getUTCDate()+Number(n||0)); return ymdUTC(d); }

async function run(){
  const key  = process.env.DATA_GO_KR_KCISA; // 인코딩 키
  const from = ymdUTC();
  const to   = plusDaysYmd(parseInt(process.env.DAYS_AHEAD||'60',10));
  const base = 'https://apis.data.go.kr/B553457/cultureInfo/period2';

  for(let page=1; page<=20; page++){
    const url = buildUrl(base, key, { _type:'json', from, to, cPage:page, rows:50 });
    console.log('[GET kcisa]', url);
    const r = await fetch(url, { headers:{Accept:'application/json'} });
    const text = await r.text();
    let items=[];
    try{
      const j = JSON.parse(text);
      items = j?.response?.body?.items || j?.response?.body?.item || j?.items || [];
      if(!Array.isArray(items)) items = items ? [items] : [];
    }catch(e){
      console.error('KCISA non-JSON head:', text.slice(0,200));
      console.error('URL:', url);
      throw e;
    }
    if(items.length===0) break;

    for(const it of items){
      const ext = String(it.cul_id || it.id || `${it.title||''}|${it.startDate||''}|${it.place||''}`);
      await upsertRaw({
        source:'kcisa',
        dataset:'performance',
        external_id: ext,
        lang:'ko',
        payload: it,
        event_start: it.startDate?.slice(0,10) || null,
        event_end:   it.endDate?.slice(0,10)   || null,
        city: it.place || null
      }).catch(err=>console.error('upsert error:', err.message));
    }
    if(items.length<50) break;
  }
}
run().catch(e=>{ console.error(e); process.exit(1); });
